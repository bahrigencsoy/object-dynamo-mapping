package [(${project.packageName})];

import software.amazon.awssdk.services.dynamodb.DynamoDbClient;
import software.amazon.awssdk.services.dynamodb.model.*;

import java.util.Map;
import java.util.HashMap;
import java.util.Optional;

public class [(${project.factoryClass})] {

    private final DynamoDbClient client;

    public [(${project.factoryClass})](DynamoDbClient client) {
        this.client = client;
    }
[# th:each="item : ${project.allItems}"]
    private static [(${item.name})] __construct[(${item.name})](Map<String, AttributeValue> map) {
        [# th:insert="~{construct-object}"][/]
        return obj;
    }

    public [(${item.name})] put[(${item.name})]( [# th:insert="~{all-attributes-types}"][/] )
    {
        if ([(${item.table.partitionKey.attribute})] == null) {
            throw new NullPointerException("Partition key \"[(${item.table.partitionKey.name})]\" is null");
        }
        if ([(${item.table.sortKey.attribute})] == null) {
            throw new NullPointerException("Sort key \"[(${item.table.sortKey.name})]\" is null");
        }

        Map<String, AttributeValue> map = new HashMap<>([# th:insert="~{key}"][/]);
[# th:each="attribute : ${item.attributes}"]
        if ([(${attribute.attribute})] != null) {
            var __tmp = [(${attribute.attribute})];
            var __s = [(${attribute.converter})](__tmp);
            map.put("[(${attribute.name})]", AttributeValue.builder().[(${attribute.builder})](__s).build());
        }
[/]
        PutItemRequest putItemRequest = PutItemRequest.builder()
                            .tableName("[(${item.table.name})]")
                            .item(map)
                            .returnValues(ReturnValue.ALL_OLD)
                            .build();
        var response = client.putItem(putItemRequest);
        if (response.hasAttributes()) {
            // FIXME this means that there was a previous object with same key
            // don't know what to do
            var previousObject = __construct[(${item.name})](response.attributes());
        }
        var obj = __construct[(${item.name})](map);
        obj._setClient(client);
        return obj;
    }

     public Optional<[(${item.name})]> query[(${item.name})]( [# th:insert="~{key-attributes-types}"][/] )
     {
        GetItemRequest getItemRequest = GetItemRequest.builder()
                                            .tableName("[(${item.table.name})]")
                                            .key([# th:insert="~{key}"][/])
                                        .build();

        GetItemResponse result = client.getItem(getItemRequest);

        if (result.item().isEmpty()) {
            return Optional.empty();
        }
        Map<String, AttributeValue> map = result.item();
        var obj = __construct[(${item.name})](map);
        obj._setClient(client);
        return Optional.of(obj);
     }
[/]
     private static String __l(Long val) {
        return Long.toString(val);
     }

     private static Long __lx(String val) {
         return Long.parseLong(val);
     }

     private static String __s(String val) {
        return val;
     }

     private static String __sx(String val) {
         return val;
     }
}