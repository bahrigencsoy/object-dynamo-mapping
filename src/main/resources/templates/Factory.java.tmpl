package [(${project.packageName})];

import software.amazon.awssdk.services.dynamodb.DynamoDbClient;
import software.amazon.awssdk.services.dynamodb.model.*;

import java.util.Map;
import java.util.HashMap;

public class [(${project.factoryClass})] {

    private final DynamoDbClient client;

    public [(${project.factoryClass})](DynamoDbClient client) {
        this.client = client;
    }
[# th:each="item : ${project.allItems}"]
    public [(${item.name})] put[(${item.name})]( [# th:insert="~{all-attributes-types}"][/] )
    {
        if ([(${item.table.partitionKey.attribute})] == null) {
            throw new NullPointerException("Partition key \"[(${item.table.partitionKey.name})]\" is null");
        }
        if ([(${item.table.sortKey.attribute})] == null) {
            throw new NullPointerException("Sort key \"[(${item.table.sortKey.name})]\" is null");
        }

        Map<String, AttributeValue> map = new HashMap<>([# th:insert="~{key}"][/]);
[# th:each="attribute : ${item.attributes}"]
        if ([(${attribute.attribute})] != null) {
            map.put("[(${attribute.name})]", AttributeValue.builder().[(${attribute.builder})]([(${attribute.attribute})]).build());
        }
[/]
        PutItemRequest putItemRequest = PutItemRequest.builder()
                            .tableName("[(${item.table.name})]")
                            .item(map)
                            .returnValues(ReturnValue.ALL_OLD)
                            .build();
        var response = client.putItem(putItemRequest);
        if (response.hasAttributes()) {
            // FIXME
            System.out.println(response);
        }
[# th:insert="~{construct-object}"][/]
        obj._setClient(client);
        return obj;
    }

     public [(${item.name})] query[(${item.name})]( [# th:insert="~{key-attributes-types}"][/] )
     {
        GetItemRequest getItemRequest = GetItemRequest.builder()
                                            .tableName("[(${item.table.name})]")
                                            .key([# th:insert="~{key}"][/])
                                        .build();

        GetItemResponse result = client.getItem(getItemRequest);

        if (result.item().isEmpty()) {
            return null;
        }
        Map<String, AttributeValue> map = result.item();
[# th:insert="~{construct-object}"][/]
        obj._setClient(client);
        return obj;
     }
[/]
}