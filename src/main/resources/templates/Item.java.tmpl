package [(${project.packageName})];

import software.amazon.awssdk.services.dynamodb.DynamoDbClient;
import software.amazon.awssdk.services.dynamodb.model.*;

import java.util.*;

import static [(${project.packageName})].lib.*;

public class [(${item.name})] {
[# th:each="attribute : ${item.allAttributes}"]
    private [(${attribute.javaType})] [(${attribute.attribute})];
    static final lib.AttributeHelper<[(${attribute.javaType})]> [(${attribute.helper})] = new lib.[(${attribute.helperClass})]("[(${attribute.name})]");
[/]
    private transient DynamoDbClient _client;

    [(${item.name})]([# th:insert="~{all-attributes-types}"][/] )
    {[# th:each="attribute : ${item.allAttributes}"]
        this.[(${attribute.attribute})] = [(${attribute.attribute})];[/]
    }
[# th:each="attribute : ${item.allAttributes}"]
    public [(${attribute.javaType})] get[(${#strings.capitalizeWords(attribute.attribute)})]() {
        return [(${attribute.attribute})];
    }

[/]

    void _setClient(DynamoDbClient client) {
        this._client = client;
    }

    public Mutator mutator() {
        var map = new HashMap<String, AttributeValue>();
        [# th:insert="~{key}"][/];
        return new Mutator(_client, map);
    }

    public static class Mutator {

        private final List<FieldMutator> mutators = new ArrayList<>();
        private final DynamoDbClient client;
        private final Map<String, AttributeValue> key;

        Mutator(DynamoDbClient client, Map<String, AttributeValue> key) {
            this.client = client;
            this.key = Map.copyOf(key);
        }

[# th:each="attribute : ${item.attributes}"]
        public GenericMutator<[(${attribute.javaType})], Mutator> [(${attribute.attribute})]() {
            var mutator = new GenericMutator<>("[(${attribute.name})]", this, [(${attribute.helper})]);
            mutators.add(mutator);
            return mutator;
        }
[/]

        public [(${item.name})] commit() {
             HashMap<String,AttributeValueUpdate> updatedValues = new HashMap<>();
             for (var mutator:mutators) {
                mutator.accept(updatedValues);
             }
             var updateItemRequest = UpdateItemRequest.builder().
                                     key(key)
                                     .tableName("[(${item.table.name})]")
                                     .attributeUpdates(updatedValues)
                                     .returnValues(ReturnValue.ALL_NEW)
                                     .build();
              UpdateItemResponse response = client.updateItem(updateItemRequest);
              Map<String, AttributeValue> map = response.attributes();
[# th:insert="~{construct-object}"][/]
              obj._setClient(client);
              return obj;
        }

        public void delete() {
            DeleteItemRequest request = DeleteItemRequest.builder().tableName("[(${item.table.name})]").key(key).build();
            var response = client.deleteItem(request);
        }
    }
}