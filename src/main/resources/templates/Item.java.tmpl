package [(${project.packageName})];

import software.amazon.awssdk.services.dynamodb.DynamoDbClient;
import software.amazon.awssdk.services.dynamodb.model.*;

import java.util.*;

import static [(${project.packageName})].lib.*;

public class [(${item.name})] {
[# th:each="attribute : ${item.allAttributes}"]
    private final [(${attribute.javaType})] [(${attribute.attribute})];
[/]
    private transient DynamoDbClient _client;

    [(${item.name})](Builder b)
    {[# th:each="attribute : ${item.allAttributes}"]
        this.[(${attribute.attribute})] = b.[(${attribute.attribute})];[/]
    }
[# th:each="attribute : ${item.allAttributes}"]
    public [(${attribute.javaType})] [(${attribute.attribute})]() {
        return [(${attribute.attribute})];
    }

[/]

    void _setClient(DynamoDbClient client) {
        this._client = client;
    }

    public Mutator mutator() {
        var map = new HashMap<String, AttributeValue>();
        [# th:insert="~{key}"][/];
        return new Mutator(_client, map);
    }

    public static class Mutator {

        private final List<FieldMutator> mutators = new ArrayList<>();
        private final DynamoDbClient client;
        private final Map<String, AttributeValue> key;

        Mutator(DynamoDbClient client, Map<String, AttributeValue> key) {
            this.client = client;
            this.key = Map.copyOf(key);
        }

[# th:each="attribute : ${item.derivedAttributes}"]
        public GenericMutator<[(${attribute.javaType})], Mutator> [(${attribute.attribute})]() {
            var mutator = new GenericMutator<>("[(${attribute.name})]", this, [(${attribute.helper})]);
            mutators.add(mutator);
            return mutator;
        }
[/]

        public [(${item.name})] commit() {
             HashMap<String,AttributeValueUpdate> updatedValues = new HashMap<>();
             for (var mutator:mutators) {
                mutator.accept(updatedValues);
             }
             var updateItemRequest = UpdateItemRequest.builder().
                                     key(key)
                                     .tableName("[(${item.table.name})]")
                                     .attributeUpdates(updatedValues)
                                     .returnValues(ReturnValue.ALL_NEW)
                                     .build();
              UpdateItemResponse response = client.updateItem(updateItemRequest);
              Map<String, AttributeValue> map = response.attributes();
              [(${item.name})].Builder builder = [(${item.name})].builder();
[# th:insert="~{construct-object}"][/]
              var obj = builder.build();
              obj._setClient(client);
              return obj;
        }

        public void delete() {
            DeleteItemRequest request = DeleteItemRequest.builder().tableName("[(${item.table.name})]").key(key).build();
            var response = client.deleteItem(request);
        }
    }

[# th:each="attribute : ${item.allAttributes}"]
    static final lib.AttributeHelper<[(${attribute.javaType})]> [(${attribute.helper})] = new lib.[(${attribute.helperClass})]("[(${attribute.name})]");
[/]

    public static Builder builder() { return new Builder(); }

    public static final class Builder {
[# th:each="attribute : ${item.allAttributes}"]
        private [(${attribute.javaType})] [(${attribute.attribute})];
[/]
        private Builder() {}
[# th:each="attribute : ${item.allAttributes}"]
        public Builder [(${attribute.attribute})]([(${attribute.javaType})] [(${attribute.attribute})]) {
            this.[(${attribute.attribute})] = [(${attribute.attribute})];
            return this;
        }
[/]
        public [(${item.name})] build() {
            return new [(${item.name})](this);
        }
    }

}