package [(${project.packageName})];

import software.amazon.awssdk.services.dynamodb.DynamoDbClient;
import software.amazon.awssdk.services.dynamodb.model.*;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import java.util.function.BiFunction;

import static [(${project.packageName})].lib.*;

public class [(${item.name})] {
[# th:each="attribute : ${item.allAttributes}"]
    private [(${attribute.javaType})] [(${attribute.attribute})];
[/]
    private transient DynamoDbClient _client;

    [(${item.name})]([# th:insert="~{all-attributes-types}"][/] )
    {[# th:each="attribute : ${item.allAttributes}"]
        this.[(${attribute.attribute})] = [(${attribute.attribute})];[/]
    }
[# th:each="attribute : ${item.allAttributes}"]
    public [(${attribute.javaType})] get[(${#strings.capitalizeWords(attribute.attribute)})]() {
        return [(${attribute.attribute})];
    }

[/]

    void _setClient(DynamoDbClient client) {
        this._client = client;
    }

    public Mutator mutator() {
        var key = [# th:insert="~{key}"][/];
        return new Mutator(_client, key);
    }

    public static class Mutator {

        private List<FieldMutator> mutators = new ArrayList<>();
        private DynamoDbClient client;
        private Map<String, AttributeValue> key;

        Mutator(DynamoDbClient client, Map<String, AttributeValue> key) {
            this.client = client;
            this.key = key;
        }

[# th:each="attribute : ${item.attributes}"]
        public [(${attribute.javaType})]FieldMutator [(${attribute.attribute})]_() {
            var mutator = new [(${attribute.javaType})]FieldMutator( "[(${attribute.name})]", this );
            mutators.add(mutator);
            return mutator;
        }
[/]

[# th:each="attribute : ${item.attributes}"]
        public GenericMutator<[(${attribute.javaType})], Mutator> [(${attribute.attribute})]() {
            var mutator = new GenericMutator<>("[(${attribute.name})]", this, AttributeValue.Builder::[(${attribute.converter})]);
            mutators.add(mutator);
            return mutator;
        }
[/]

        public [(${item.name})] commit() {
             HashMap<String,AttributeValueUpdate> updatedValues = new HashMap<>();
             for (var mutator:mutators) {
                mutator.accept(updatedValues);
             }
             var updateItemRequest = UpdateItemRequest.builder().
                                     key(key)
                                     .tableName("[(${item.table.name})]")
                                     .attributeUpdates(updatedValues)
                                     .returnValues(ReturnValue.ALL_NEW)
                                     .build();
             var response = client.updateItem(updateItemRequest);
             var map = response.attributes();
[# th:insert="~{construct-object}"][/]
              obj._setClient(client);
              return obj;
        }
    }
}